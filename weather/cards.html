<!DOCTYPE html>
<html lang="en">
<!DOCTYPE html>
<!-- 
    Weather Display Webpage
    Author: Christian Prior-Mamulyan
    Version: 2.1
    Date: 2024-03-10
    Sourcecode: https://github.com/cprima/simple-weather-cards
    Description: This webpage dynamically generates weather cards with daylight information after 5 PM for cities worldwide, using OpenWeatherMap API data. It aims to foster empathy and connection within global project teams by sharing local weather conditions at the beginning of online meetings.
    License: Creative Commons Attribution (CC BY)
    Note: This work is licensed under a Creative Commons Attribution 4.0 International License. For more details, visit https://creativecommons.org/licenses/by/4.0/
 -->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Display</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root {
      --primary-color: #cb4b16;
      --secondary-color: #eee8d5;
      --header-height: 4px;
      --footer-height: 60px;
      --main-content-padding-top: 20px;
      --footer-link-color: #CCCCCC;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: Arial, sans-serif;
      background-color: var(--secondary-color);
    }

    header {
      width: 100%;
      height: var(--header-height);
      background-color: var(--primary-color);
    }

    .main-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding-top: var(--main-content-padding-top);
    }

    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    footer#site-footer {
      width: 100%;
      height: var(--footer-height);
      background-color: var(--secondary-color);
    }

    .footer-content {
      color: var(--footer-link-color);
      display: flex;
      justify-content: space-evenly;
      align-items: center;
      height: 100%;
    }

    .footer-link {
      color: var(--footer-link-color);
      text-decoration: none;
    }

.weather-card {
    display: flex;
    flex-direction: column;
    min-width: 250px;
    max-width: 300px;
    background-color: var(--secondary-color);
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.weather-card .header {
    padding: 15px;
    background-color: var(--primary-color);
    color: var(--secondary-color);
    text-align: center;
}

.weather-card .main {
    color: var(--primary-color);
    padding: 15px;
}

.weather-card .main .item {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.weather-card .main .item .visualization {
    margin-right: 8px;
}

.weather-card .main .item .visualization i {
    margin-right: 8px;
    opacity: 0.3;
}

.weather-card .main .item .text {
    display: flex;
    align-items: center; /* Vertically aligns text with the icon */
    flex-grow: 1; /* Allows text container to fill the available space */
}

.weather-card .main .item .text .label {
    opacity: 0.7;
}

.weather-card .main .item .text .data {
    margin-left: auto; 
}




  </style>
</head>

<body>

  <header>&nbsp;</header>
  <div class="main-content">
    <div id="weathercards" class="container"></div>
  </div>
  <footer id="site-footer">
    <div class="footer-content">
      <span id="cache-age">Cache: Loading...</span>
      <a href="https://github.com/cprima/simple-weather-cards" target="_blank" class="footer-link">GitHub Repository</a>
      <a href="https://cpr.in-berlin.de/weather/" class="footer-link">0</a>
      <a href="https://cpr.in-berlin.de/weather/?cities=2946447,3067696,1264527,6697380&primaryColor=D40511&secondaryColor=FFCC00&padTop=120px"
        class="footer-link">A</a>
      <a href="https://cpr.in-berlin.de/weather/?cities=2946447,2806654,1273294,1264527&primaryColor=D40511&secondaryColor=FFCC00&padTop=120px"
        class="footer-link">B</a>
    </div>
  </footer>

  <script>

    // Mapping of city IDs to custom display names
    const cityIdToNameMapping = {
      "6697380": "Cyberjaya",
      "2866375": "Rittershausen",
    };

    document.addEventListener("DOMContentLoaded", () => {
      const app = document.getElementById('weathercards');
      app.className = 'container';
      const footer = document.getElementById('cache-info');
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let cities = '2857458,2806654,2866375,616530,617026,611717';

      // colors
      let primaryColor = `#${urlParams.get('primaryColor') || 'cb4b16'}`; // Default to Solarized orange if not specified
      let secondaryColor = `#${urlParams.get('secondaryColor') || 'eee8d5'}`; // Default to Solarized base2 if not specified
      const footerLinkColor = mixWithBlack(secondaryColor.slice(1), 4);
      let padTop = `${urlParams.get('padTop') || '20px'}`;
      document.documentElement.style.setProperty('--primary-color', primaryColor);
      document.documentElement.style.setProperty('--secondary-color', secondaryColor);
      document.documentElement.style.setProperty('--footer-link-color', footerLinkColor);
      document.documentElement.style.setProperty('--main-content-padding-top', padTop);

      if (urlParams.has('cities')) {
        cities = urlParams.get('cities');
      }

      // Adjust this URL to point to your PHP proxy script
      const apiUrl = `/weather/openweathermap_proxy.php?ids=${cities}`;

      fetch(apiUrl)
        .then(response => {
          // Access custom headers
          const cacheState = response.headers.get('X-Cache');
          let cacheAge = response.headers.get('X-Cache-Age');
          console.log(`Cache State: ${cacheState}, Cache Age: ${cacheAge} seconds`);
          // Handle an unset 'X-Cache-Age'
          if (cacheAge === null) {
            cacheAge = 'Unavailable'; // or any default/fallback message you prefer
          } else {
            cacheAge = 'Age ' + cacheAge + ' seconds'; // Append 'seconds' only if the cache age is available
          }

          // Update the cache age display
          const cacheAgeSpan = document.getElementById('cache-age');
          cacheAgeSpan.textContent = `Cache: ${cacheAge}`;

          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            console.error('Error fetching weather data:', data.details);
            // Handle error in UI, e.g., show an error message
          } else {
            data.list.forEach(weatherData => {
              const card = createWeatherCard(weatherData); // Capture the returned card
              app.appendChild(card); // Append the card to the 'app' container
            });
          }
        })
        .catch(error => console.error("Error fetching weather data:", error));

    });

    function getCityDisplayName(cityId, defaultName) {
      // Check if the cityId exists in the mapping, return the custom name if it does
      // Otherwise, return the default name from OpenWeatherMap
      return cityIdToNameMapping[cityId] || defaultName;
    }

    function createWeatherCard(openweatherdata) {

      const cityId = openweatherdata.id.toString();
      const defaultCityName = openweatherdata.name;
      const displayName = getCityDisplayName(cityId, defaultCityName);

      // Create the card container
      const card = document.createElement('div');
      card.className = 'weather-card';

      // Header with city name
      const header = document.createElement('div');
      header.className = 'header';
      header.textContent = displayName

      // Main content area
      const main = document.createElement('div');
      main.className = 'main';

      // Temperature item
      const tempItem = document.createElement('div');
      tempItem.className = 'item';
      tempItem.innerHTML = `<div class="visualization"><i class="material-icons">thermostat</i></div><div class="text"><span class="label">Temperature:</span><span class="data">${Math.round(openweatherdata.main.temp * 10) / 10}°C</span></div>`;

      // Humidity item
      const humidityItem = document.createElement('div');
      humidityItem.className = 'item';
      humidityItem.innerHTML = `<div class="visualization"><i class="material-icons">water_drop</i></div><div class="text"><span class="label">Humidity:</span><span class="data">${openweatherdata.main.humidity}%</span></div>`;

      // Weather condition item
      const conditionItem = document.createElement('div');
      conditionItem.className = 'item';
      const iconCode = openweatherdata.weather[0].icon; // Assuming there's at least one weather condition present
      conditionItem.innerHTML = `<div class="visualization"><img src="https://openweathermap.org/img/wn/${iconCode}.png" alt="Weather Icon"></div><div class="text"><span class="data">${openweatherdata.weather[0].main}</span></div>`;

      // Daylight item
      const daylightItem = document.createElement('div');
      daylightItem.className = 'item';
      let daylightAfter5PM = calculateDaylightAfter5PM(openweatherdata);
      let daylightText = daylightAfter5PM > 0 ? convertSecondsToFractionalHours(daylightAfter5PM) : '-';
      daylightItem.innerHTML = `<div class="visualization"><i class="material-icons">wb_sunny</i></div><div class="text"><span class="label">after 5 pm:</span><span class="data">${daylightText}</span></div>`;

      // Append items to the list
      main.appendChild(conditionItem);
      main.appendChild(tempItem);
      main.appendChild(humidityItem);
      main.appendChild(daylightItem);

      // Append elements to main content area and card
      card.appendChild(header);
      card.appendChild(main);

      return card;
    }


    // Function to mix the secondary color with black (80% secondary color, 20% black)
    function mixWithBlack(color, percentage) {
      const percent = percentage / 100;
      // Parse the hex color
      const [r, g, b] = color.match(/\w\w/g).map(x => parseInt(x, 16));
      // Calculate the mixed color
      const mixedColor = [
        Math.round(r * (1 - percent)).toString(16).padStart(2, '0'),
        Math.round(g * (1 - percent)).toString(16).padStart(2, '0'),
        Math.round(b * (1 - percent)).toString(16).padStart(2, '0')
      ].join('');
      return `#${mixedColor}`;
    }

    function calculateDaylightAfter5PM(city) {
      //console.log(`Calculating daylight after 5 PM for city: ${city.name}`);

      // Calculate local time for sunset and 5 PM using the city's timezone offset
      const sunsetLocal = new Date((city.sys.sunset + city.sys.timezone) * 1000);
      const fivePMLocal = new Date(sunsetLocal);
      fivePMLocal.setUTCHours(17, 0, 0, 0); // Set time to 17:00 UTC which is equivalent to 5 PM local
      fivePMLocal.setUTCDate(sunsetLocal.getUTCDate()); // Ensure 5 PM is on the same day as sunset

      // Debug output
      //console.log(`Local sunset time: ${formatDateTimeWithTimezone(sunsetLocal)}`);
      //console.log(`Local 5 PM time: ${formatDateTimeWithTimezone(fivePMLocal)}`);

      // Calculate the difference in milliseconds
      const diffMs = sunsetLocal - fivePMLocal;
      const diffSeconds = diffMs > 0 ? diffMs / 1000 : 0; // Convert to seconds, ensure non-negative

      // More debug output
      /*if (diffSeconds > 0) {
        console.log(`Daylight after 5 PM: ${diffSeconds} seconds`);
      } else {
        console.log("It is already dark at 5 PM.");
      }*/

      return diffSeconds;
    }


    function formatDateTimeWithTimezone(date) {
      const options = {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        timeZoneName: 'short'
      };
      return date.toLocaleString('en-US', options);
    }


    function convertSecondsToFractionalHours(seconds) {
      // Convert seconds to hours as a decimal
      let decimalHours = seconds / 3600;

      // Extract the whole hour part
      let wholeHours = Math.floor(decimalHours);

      // Find the decimal part to determine the fraction
      let decimalPart = decimalHours - wholeHours;

      // Determine the closest fraction
      let fraction = "";
      if (decimalPart > 0) {
        if (decimalPart <= 1 / 4) {
          fraction = "¼";
        } else if (decimalPart <= 1 / 2) {
          fraction = "½";
        } else if (decimalPart <= 3 / 4) {
          fraction = "¾";
        } else {
          // If the decimal part is closer to 1 than to 3/4, increment wholeHours
          wholeHours += 1;
        }
      }

      // Construct the final string
      let result = wholeHours.toString();
      if (fraction) {
        result += fraction;
      }
      return result + " h";
    }

  </script>

</body>

</html>